## DVC example project for checkpoints

![DVC](https://img.shields.io/badge/-tracked-white.svg?logo=data-version-control&link=https://dvc.org/?utm_campaign=badge)

[![DVC](https://img.shields.io/badge/-Data_Version_Control-white.svg?logo=data-version-control&style=social)](https://dvc.org/?utm_campaign=badge)

![](https://img.shields.io/badge/dynamic/json?logo=data-version-control&colorA=black&colorB=F46737&label=Model%20Accuracy&url=https://github.com/iterative/dvc-example-checkpoints/raw/dvclive/metrics.json&query=acc)

This project is a showcase for the checkpoints features in DVC 2.0 and
[`dvclive`][dvcl]. It shows how to use checkpoints in various ways by training a
a CNN model to classify [Fashion
MNIST](https://github.com/zalandoresearch/fashion-mnist) dataset in Tensorflow.

[dvcl]: https://dvc.org/doc/dvclive

All four branches are cloned and installed similarly: 

```console
git clone https://github.com/iterative/dvc-example-checkpoints -b basic
cd dvc-example-checkpoints
virtualenv .venv
. .venv/bin/activate
python -m pip install -r requirements.txt
```

You can also clone `https://github.com/iterative/dvc-example-checkpoints` with
all the tags and use `git checkout` to navigate among them. 

### Branches

- [`basic`][basict]: Shows how to use checkpoints by modifying `dvc.yaml`. 

In `dvc.yaml`, the following changes are done. You can also specify this by
using `--checkpoints/-c` option to `dvc stage add`.

[basict]: https://github.com/iterative/dvc-example-checkpoints/tree/basic

```yaml
    outs:
      - models/fashion-mnist/model.h5:
          checkpoint: true
```

- [`dvclive`][dvclivet]: Shows how to use [dvclive callback] for Keras to record
 the model and the metrics automatically in every checkpoint. 

[dvclive callback]: https://dvc.org/doc/dvclive/user-guide/ml-frameworks/keras
[dvclivet]: https://github.com/iterative/dvc-example-checkpoints/tree/dvclive

```python
    def on_epoch_end(self, epoch, logs=None):
        logs = logs or {}
        for metric, value in logs.items():
            dvclive.log(metric, value)
        dvclive.next_step()
```

- [`python-api`][pythonapit]: Uses [make_checkpoint()][apicp] API call in a custom Tensorflow
  callback to record a checkpoint in `train.py`.

[pythonapit]: https://github.com/iterative/dvc-example-checkpoints/tree/python-api
[apicp]: https://dvc.org/doc/api-reference/make_checkpoint#dvcapimake_checkpoint

```python
    def on_epoch_end(self, epoch, logs=None):
        if (epoch % self.frequency) == 0:
            make_checkpoint()
```

- [`signal-file`][signalfilet]: This branch shows language-independent way of
  producing checkpoints. Instead of using DVC Python API or DVClive, a signal
  file is created to set the checkpoint. 

[signalfilet]: https://github.com/iterative/dvc-example-checkpoints/tree/signal-file

```python
    def dvc_signal(self):
        "Generates a DVC signal file and blocks until it's deleted"
        dvc_root = os.getenv("DVC_ROOT") # Root dir of dvc project.
        if dvc_root: # Skip if not running via dvc.
            signal_file = os.path.join(dvc_root, ".dvc", "tmp",
                "DVC_CHECKPOINT")
            with open(signal_file, "w") as f: # Write empty file.
                f.write("")
            while os.path.exists(signal_file): # Wait until dvc deletes file.
                # Wait 10 milliseconds
                time.sleep(0.01)
```

You can run the experiments similar to the [examples in documentation.][gsexp]

[gsexp]: https://dvc.org/doc/start/experiments

## Contributing

This repository is generated by
[`example-repos-dev`](https://github.com/iterative/example-repos-dev). For Pull
Requests regarding the fixes, please use that repository. 
